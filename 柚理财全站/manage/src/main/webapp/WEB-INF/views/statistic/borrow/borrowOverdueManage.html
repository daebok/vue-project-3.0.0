<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>逾期分析</title>
<#include "include/resources.html">
</head>
<body class="overflowY">
<div class="wrapper">
    <div class="row pt20">
      <div class="col-md-12">
        <div id="legend">
          <legend>逾期分析</legend>
        </div>
        <ul id="myTab" class="nav nav-tabs mt20">
          <li class="active">
            <a href="#tab1" data-toggle="tab">逾期情况分析</a>
          </li>
          <li><a href="#tab2" data-toggle="tab">逾期人信息分析</a></li>
        </ul>        
      </div>
    </div>
    <div class="tab-content">
    <!-- tab1 -->
    <div id="tab1" class="tab-pane fade in active">
      <div class="row pt20">
        <div class="col-md-12">       
          <form class="form-horizontal" id="j-form-1"> 
          <input type="hidden" name="dateType" value="1" id="dateType">    
            <div class="control-group">
              <label class="control-label">日期：</label>
              <div class="controls">
                <label class="checkbox inline selectTime"><input type="text" name="startDate" id="startTime" value="${startDate}" class="form-control" placeholder="开始日期" readonly="readonly" style="background:#fff;"/></label><label class="checkbox inline selectTime"><input type="text" value="${endDate}" name="endDate" id="endTime" class="form-control" placeholder="结束日期" readonly="readonly" style="background:#fff;"/></label>
              </div>
            </div>        
            <div class="control-group">
              <label class="control-label">用户类型：</label>
              <div class="controls">
                <label class="checkbox inline selectTime">
                  <select name="statType" id="type1" class="form-control valid"  aria-invalid="false"  style="width:198px">
                    <option value="2">逾期项目金额</option>
                    <option value="3">逾期项目笔数</option>
                    <option value="1">逾期人数量</option>
                  </select>
                </label>
              </div>
            </div>
            <div class="" style="margin-left:116px;margin-top:20px;">
              <button type="submit" name="button" class="btn btn-primary">搜索</button>
            </div>
        </form>
        </div>
      </div>
      <div class="lineStyle col-md-12"></div>
      <div class="row">
        <div class="col-md-6 col-sm-12">
           <!--  <div class="content pt20 ml30">
              <h3 class="text-right">
                <div id="timeType" class="selectTime">
                  <a href="javascript:;" id="day" class="on">日</a>
                  <a href="javascript:;" id="week">周</a>
                  <a href="javascript:;" id="month">月</a>
                </div>
            </div> -->
            <div id="j-main" class="chart-col-6 mt20 ml30" style="width:100%;margin:50px auto 0;"></div>
        </div>
        <div class="col-md-6 col-sm-12">
          <div id="j-pie-1" class="chart-col-6 mt20 ml30" style="margin:100px auto 0;">

          </div>
        </div>
      </div>

      <h3 style="height:5px;border-bottom:1px solid #ccc;"></h3>

      <div class="row" style="margin-top:30px;">
        <div class="col-md-12">
          <table class="table-td-NoOverflow ui-jqgrid-btable ui-common-table table table-bordered" tabindex="0" >
            <tbody>
              <tr class="jqgfirstrow" role="row">
                <th class="active"  colspan="9">逾期情况概况</th>
              </tr>
              <tr class="jqgfirstrow" role="row">
                <th class="active">逾期项目数</th>
                <th class="active">逾期项目率</th>
                <th class="active">逾期金额</th>
                <th class="active">金额逾期率</th>
                <th class="active">历史项目逾期金额</th>
                <th class="active">历史项目逾期率</th>
                <th class="active">累计逾期代偿金额</th>
                <th class="active">累计逾期代偿笔数</th>
                <th class="active">逾期人数</th>
              </tr>
              <tr role="row"   class="jqgrow ui-row-ltr">
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- tab1 end -->
    <div id="tab2" class="tab-pane fade">
          <form class="form-horizontal" id="j-form-2">     
            <div class="control-group">
              <label class="control-label">日期：</label>
              <div class="controls">
                <label class="checkbox inline selectTime"><input type="text" name="startDate" id="startTime2" value="2017-1-20" class="form-control" placeholder="开始日期" /></label><label class="checkbox inline selectTime"><input type="text" value="2017-3-05" name="endDate" id="endTime2" class="form-control" placeholder="结束日期"/></label>
              </div>
            </div>        
            <div class="control-group">
              <label class="control-label">用户类型：</label>
              <div class="controls">
                <label class="checkbox inline selectTime">
                  <select id="type2" class="form-control valid"  aria-invalid="false" style="width:198px">
                    <option value="1">逾期借款人信息</option>
                    <option value="2">逾期借款人所在地分布</option>
                  </select>
                </label>
              </div>
            </div>
            <div class="" style="margin-left:116px;margin-top:20px;">
              <button type="submit" name="button" class="btn btn-primary">搜索</button>
            </div>
        </form>
        <div class="lineStyle col-md-12"></div>
      <div id="j-pies">
         <div class="row pt20">
          <div class="col-md-6">
              <div class="chart-content mt20" id="j-pie-11"></div>
          </div>
          <div class="col-md-6">
              <div class="chart-content mt20" id="j-pie-12"></div>
          </div>
        </div>
        <div class="row pt20">
          <div class="col-md-6">
              <div class="chart-content mt20" id="j-pie-13"></div>
          </div>
          <div class="col-md-6">
              <div class="chart-content mt20" id="j-pie-14"></div>
          </div>
        </div>
        <div class="row pt20">
          <div class="col-md-6">
              <div class="chart-content mt20" id="j-pie-15"></div>
          </div>
        </div>       
      </div>      
      <div id="j-maps" class="hide">
        <div class="row pt20">
          <div class="col-md-6">
              <div class="chart-content mt20" id="j-map" style="width:80%;margin:50px auto 0;"></div>
          </div>
        </div>        
      </div>      
    </div>
    </div>
</div>
<script type="text/javascript">
(function(){
    //设置开始时间控件
  var startTime= {
    elem:'#startTime',
    format: 'YYYY-MM-DD', //日期格式
    max:$('#endTime').val(),
    event:'focus',
    choose: function(dates){
        endTime.min=dates;
        endTime.start=dates;
    }
  };
  //设置发放结束时间
  var endTime=  {
      elem:'#endTime',
      format: 'YYYY-MM-DD', //日期格式
      min: $('#startTime').val(), //最小日期
      event:'focus',
      choose: function(dates){
        startTime.max=dates;
       }
  };
  laydate(startTime);
  laydate(endTime);  
  var myChart = echarts.init(document.getElementById('j-main'));
  var option = {
      title: {
          text: '逾期项目人数及环比值',
          left: 'center'
      },    
      tooltip: {
          trigger: 'axis'
      },
      legend: {
          data:['逾期项目人数','环比值'],
          top:'50px'
      },
      grid:{
          top:'25%'
      },
      xAxis: [
          {
              type: 'category',
              data: []
          }
      ],
      yAxis: [
          {
              type: 'value',
              name: '逾期项目人数',
              axisLabel: {
                  formatter: '{value} '
              }
          },
          {
              type: 'value',
              name: '环比',
              axisLabel: {
                  formatter: '{value} %'
              }
          }
      ],
      dataZoom: [
       {   // 这个dataZoom组件，默认控制x轴。
           type: 'slider', // 这个 dataZoom 组件是 slider 型 dataZoom 组件
           startValue :0
       },

   ],
      series: [
          {
              name:'逾期项目人数',
              type:'bar',
              yAxisIndex: 0,
              data:[],
              itemStyle:{
                normal:{
                  color:'#66bef5'
                }
              }
          },{
              name:'环比值',
              type:'line',
              yAxisIndex: 1,
              data:[]
          }
      ]
  };

  var option1 = {
      title: {
          text: '逾期项目金额及环比值',
          left: 'center'
      },    
      tooltip: {
          trigger: 'axis'
      },
      legend: {
          data:['逾期项目金额','环比值'],
          top:'50px'
      },
      grid:{
          top:'25%'
      },
      xAxis: [
          {
              type: 'category',
              data: []
          }
      ],
      yAxis: [
          {
              type: 'value',
              name: '逾期项目金额',
              axisLabel: {
                  formatter: '{value} '
              }
          },
          {
              type: 'value',
              name: '环比',
              axisLabel: {
                  formatter: '{value} %'
              }
          }
      ],
      dataZoom: [
       {   // 这个dataZoom组件，默认控制x轴。
           type: 'slider', // 这个 dataZoom 组件是 slider 型 dataZoom 组件
           startValue :0
       },

   ],
      series: [
          {
              name:'逾期项目金额',
              type:'bar',
              yAxisIndex: 0,
              data:[],
              itemStyle:{
                normal:{
                  color:'#66bef5'
                }
              }
          },{
              name:'环比值',
              type:'line',
              yAxisIndex: 1,
              data:[]
          }
      ]
  };

  var option2 = {
      title: {
          text: '逾期项目笔数及环比值',
          left: 'center'
      },    
      tooltip: {
          trigger: 'axis'
      },
      legend: {
          data:['逾期项目笔数','环比值'],
          top:'50px'
      },
      grid:{
          top:'25%'
      },
      xAxis: [
          {
              type: 'category',
              data: []
          }
      ],
      yAxis: [
          {
              type: 'value',
              name: '逾期项目笔数',
              axisLabel: {
                  formatter: '{value} '
              }
          },
          {
              type: 'value',
              name: '环比',
              axisLabel: {
                  formatter: '{value} %'
              }
          }
      ],
      dataZoom: [
       {   // 这个dataZoom组件，默认控制x轴。
           type: 'slider', // 这个 dataZoom 组件是 slider 型 dataZoom 组件
           startValue :0
       },

   ],
      series: [
          {
              name:'逾期项目笔数',
              type:'bar',
              yAxisIndex: 0,
              data:[],
              itemStyle:{
                normal:{
                  color:'#66bef5'
                }
              }
          },{
              name:'环比值',
              type:'line',
              yAxisIndex: 1,
              data:[]
          }
      ]
  };

  chartAjax($("#j-form-1").serialize());

  function chartAjax(req){
      $.ajax({
          url:'/statistic/borrow/getBorrowOverdue.html?'+req,
          dataType:'json',
          success:function(data){
            //var timeLength=data.date.length;
            //option.dataZoom[0].startValue=timeLength;
            if($('#type1 option:selected').val()==1){
              option.xAxis[0].data=data.date;
              option.series[0].data=data.total;
              option.series[1].data=data.ratio;
              myChart.setOption(option);
            }
            else if($('#type1 option:selected').val()==2){
              option1.xAxis[0].data=data.date;
              option1.series[0].data=data.total;
              option1.series[1].data=data.ratio;
              myChart.setOption(option1);
            }
            else{
              option2.xAxis[0].data=data.date;
              option2.series[0].data=data.total;
              option2.series[1].data=data.ratio;
              myChart.setOption(option2);
            }
          }
      })
  }

 $("#timeType a").on('click',function(e){

    $("#timeType a").removeClass('on');
    $(this).addClass('on')
    
    switch (e.target.id) {
     case 'day':
        $("#dateType").val(1);
        chartAjax($(".form-horizontal").serialize())
        break;
     case 'week':
        $("#dateType").val(2);
        chartAjax($(".form-horizontal").serialize())
        break;
     case 'month':
        $("#dateType").val(3);
        chartAjax($(".form-horizontal").serialize())
       break;
     default:
   }
 });

$("#type1").change(function(event) {
  $("#j-form-1").submit();
});

//饼图
  var pieChart = echarts.init(document.getElementById('j-pie-1'));
  var pieOption= {
          title : {
              text: '',
              left: 'center'
          },
          tooltip : {
              trigger: 'item',
              formatter: "{a} <br/>{b} : {c} ({d}%)"
          },
          legend: {
              orient : 'vertical',
              x : '80%',
              y : '40%',
              data:[]
          },
          toolbox: {
              show : false
          },
          calculable : true,
          series : [
              {
                  name:'访问来源',
                  type:'pie',
                  radius : '55%',
                  center: ['50%', '60%'],
                  color:['#76b7f9','#f8d15c','#ef826f','#92cb8b','#c3e9e1','#ffa879','#95a3ea','#ba7dd1'],
                  itemStyle : {
                      normal : {
                          label : {
                              position : 'inner',
                              formatter : function (params) {
                               return params.percent + '%'
                              }
                          },
                          labelLine : {
                              show : false
                          }
                      },
                      emphasis : {
                          label : {
                              show : false,
                              formatter : "{b}\n{d}%"
                          }
                      }

                  },
                  data:[]
              }
          ]
      };

pieChartAjax($("#j-form-1").serialize());

function pieChartAjax(req,range){
    $.ajax({
        url:'/statistic/borrow/getBorrowOverdueRate.html?'+req,
        dataType:'json',
        success:function(data){

            var pie1 = [],legend1 = [];

            for( x in data )
            {
              pie1.push({value:data[x],name:x});
              legend1.push(x);
            }

            if($('#type1 option:selected').val()==1){
              $("#j-pie-1").hide();
            }
            else if($('#type1 option:selected').val()==2){
              $("#j-pie-1").show();
              pieOption.title.text='金额分级逾期率';
              pieOption.legend.data = legend1;
              pieOption.series[0].data = pie1;
              pieChart.setOption(pieOption);
            }
            else{
              $("#j-pie-1").show();
              pieOption.title.text='笔数分级逾期率';
              pieOption.legend.data = legend1;
              pieOption.series[0].data = pie1;
              pieChart.setOption(pieOption);
            }
            
        }
    })
}


/* 获取表格数据 */
(function getinfo(){
    $.ajax({
        url:'/statistic/borrow/getOverdueInfo.html',
        dataType:'json',
        success:function(data){
             var td = $("table tr").eq(2).find("td");
             td.eq(0).html(data.overdueNum);
             td.eq(1).html(data.overdueRatio);
             td.eq(2).html(data.overdueAccount);
             td.eq(3).html(data.overdueAccountRatio);
             td.eq(4).html(data.oldOverdueAccount);
             td.eq(5).html(data.oldOverdueRatio);
             td.eq(6).html(data.commutationNum);
             td.eq(7).html(data.commutationAccount);
             td.eq(8).html(data.overdueBorrower);
          }

    })
})();

/* submit事件 */
 $("#j-form-1").submit(function (e) {
   e.preventDefault()
   chartAjax($(this).serialize());
   pieChartAjax($(this).serialize());
 });
})();

/* tab2 */
(function(){

  //设置开始时间控件
  var startTime= {
    elem:'#startTime2',
    format: 'YYYY-MM-DD', //日期格式
    max:$('#endTime2').val(),
    event:'focus',
    choose: function(dates){
        endTime.min=dates;
        endTime.start=dates;
    }
  };
  //设置发放结束时间
  var endTime=  {
      elem:'#endTime2',
      format: 'YYYY-MM-DD', //日期格式
      min: $('#startTime2').val(), //最小日期
      event:'focus',
      choose: function(dates){
        startTime.max=dates;
       }
  };
  laydate(startTime);
  laydate(endTime);

 $("#j-form-2").submit(function (e) {
   e.preventDefault();
   chartAjax($('#j-form-2').serialize());
 });

  var myChart = echarts.init(document.getElementById('j-pie-11')),
      myChart2 = echarts.init(document.getElementById('j-pie-12')),
      myChart3 = echarts.init(document.getElementById('j-pie-13')),
      myChart4 = echarts.init(document.getElementById('j-pie-14')),
      myChart5 = echarts.init(document.getElementById('j-pie-15'));
  var option= {
          title : {
              text: '',
              left: 'center'
          },
          tooltip : {
              trigger: 'item',
              formatter: "{a} <br/>{b} : {c} ({d}%)"
          },
          legend: {
              orient : 'vertical',
              x : '80%',
              y : '40%',
              data:[]
          },
          toolbox: {
              show : false
          },
          calculable : true,
          series : [
              {
                  name:'访问来源',
                  type:'pie',
                  radius : '55%',
                  center: ['50%', '60%'],
                  color:['#76b7f9','#f8d15c','#ef826f','#92cb8b','#c3e9e1','#ffa879','#95a3ea','#ba7dd1'],
                  itemStyle : {
                      normal : {
                          label : {
                              position : 'inner',
                              formatter : function (params) {
                               return params.percent + '%'
                              }
                          },
                          labelLine : {
                              show : false
                          }
                      },
                      emphasis : {
                          label : {
                              show : false,
                              formatter : "{b}\n{d}%"
                          }
                      }

                  },
                  data:[]
              }
          ]
      };
  var option2 = jQuery.extend(true, {}, option);
  var option3 = jQuery.extend(true, {}, option);
  var option4 = jQuery.extend(true, {}, option);
  var option5 = jQuery.extend(true, {}, option);

chartAjax($('#j-form-2').serialize());

function chartAjax(req,range){
    $.ajax({
        url:'/statistic/borrow/getBorrowOverdueInfo.html?'+req,
        dataType:'json',
        success:function(data){

            var pie1 = [],pie2 = [], pie3 = [], pie4 = [], pie5 = [],legend1 = [],legend2 = [],legend3 = [],legend4 = [],legend5 = [];
            for( x in data[0] )
            {
              pie1.push({value:data[0][x],name:x});
              legend1.push(x);
            }

            for( y in data[1] )
            {
              pie2.push({value:data[1][y],name:y});
              legend2.push(y);
            }

            for( m in data[2] )
            {
              pie3.push({value:data[2][m],name:m});
              legend3.push(m);
            }

            for( a in data[3] )
            {
              pie4.push({value:data[3][a],name:a});
              legend4.push(a);
            }

            for( b in data[4] )
            {
              pie5.push({value:data[4][b],name:b});
              legend5.push(b);
            }

            option.title.text='性别分布';
            option.legend.data = legend1;
            option.series[0].data = pie1;

            option2.title.text='年龄分布';
            option2.legend.data = legend2;
            option2.series[0].data = pie2;

            option3.title.text='文化程度分布';
            option3.legend.data = legend3;
            option3.series[0].data = pie3;

            option4.title.text='婚姻状况分布';
            option4.legend.data = legend4;
            option4.series[0].data = pie4;

            option5.title.text='用户类型分布';
            option5.legend.data = legend5;
            option5.series[0].data = pie5;

            myChart.setOption(option);
            myChart2.setOption(option2);
            myChart3.setOption(option3);
            myChart4.setOption(option4);
            myChart5.setOption(option5);         

        }
    })
}


$("#type2").change(function(event) {
  $("#j-maps,#j-pies").addClass('hide');
  if($(this).val() == "1"){
    $("#j-pies").removeClass('hide');
  }
  else
  {
    $("#j-maps").removeClass('hide');
    setMap();
  }  
});

})();

/* map */ 
setMap();
function setMap(){

  var myChart = echarts.init(document.getElementById('j-map'));

  var option= {
      title: {
          text: '预期借款人所在地分布',
          left: 'center'
      },
      tooltip: {
          trigger: 'item',
          formatter: function(params) {
                var res = params.name+'<br/>';
                var myseries = option.series;
                for (var i = 0; i < myseries.length; i++) {
                    for(var j=0;j<myseries[i].data.length;j++){
                      if(myseries[i].data[j].name==params.name ){
                          res+= myseries[i].name;
                          res+=' : '+myseries[i].data[j].value+'</br>';
                      }
                    }
                }
                return res;
          }
      },
      legend: {
          orient: 'vertical',
          left: 'left',
          data:['人数']
      },
      visualMap: {
          min: 0,
          max: 2500,
          left: 'left',
          top: 'bottom',
          text: ['高','低'],           // 文本，默认为数值文本
          calculable: true
      },
      toolbox: {
          show: true,
          orient: 'vertical',
          left: '700px',
          top: 'center',
          feature: {
              dataView: {readOnly: false},
              restore: {},
              saveAsImage: {}
          }
      },
      series: [
          {
              name: '人数',
              type: 'map',
              mapType: 'china',
              roam: false,
              label: {
                  normal: {
                      show: true
                  },
                  emphasis: {
                      show: true
                  }
              },
              data:[]
          }
      ]
  };

chartAjax($('#j-form-2').serialize());

function chartAjax(req){
    $.ajax({
        url:'/statistic/borrow/getBorrowOverdueArea.html?'+req,
        dataType:'json',
        success:function(data){

          option.series[0].data = data.total;

          myChart.setOption(option);

          }

    })
}
}
</script>
</body>
</html>